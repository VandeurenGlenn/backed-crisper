{"version":3,"file":"crisper-node.js","sources":["../src/crisper.js"],"sourcesContent":["'use strict';\r\nconst path = require('path');\r\nconst {readFile, mkdir, writeFile} = require('fs');\r\nconst parse5 = require('parse5');\r\n\r\nconst isTextNode = (node) => {\r\n  return Boolean(node.nodeName === '#text');\r\n}\r\n\r\nconst resolvePath = source => {\r\n  return path.win32.resolve(process.cwd(), source);\r\n}\r\n\r\nconst relativePath = source => {\r\n  return path.win32.relative(process.cwd(), source);\r\n}\r\n\r\n/**\r\n * @param {string} source A path to construct the destintation path from\r\n * @param {string} dest A destination path to join with source path\r\n *\r\n * @example\r\n * distPath('src/html/index.html', 'dist') // returns dist/html/index.html\r\n */\r\nconst distPath = (source, dest) => {\r\n  if (dest === null) {\r\n    dest = 'dist';\r\n  }\r\n  return path.win32.join(path.win32.dirname(source), dest, path.win32.basename(source))\r\n}\r\n\r\nconst write = (destination, content) => {\r\n  writeFile(destination, content, error => {\r\n    if (error) {\r\n      if (error.code === 'ENOENT') {\r\n        const relative = relativePath(destination);\r\n        const parts = path.win32.dirname(relative).split(path.sep);\r\n        let prepath = '';\r\n\r\n        for (let part of parts) {\r\n          prepath = path.join(prepath, part);\r\n          mkdir(prepath, error => {\r\n            return console.error(error);\r\n          });\r\n        }\r\n        return write(destination, content);\r\n      } else {\r\n        console.log(error);\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\nconst writeJs = (path, content) => {\r\n  write(path, content);\r\n}\r\n\r\nconst resolvePaths = (source, html, js, dist) => {\r\n  return new Promise((resolve, reject) => {\r\n    try {\r\n      const duplicates = {html: false, js: false};\r\n      if (html === source) {\r\n        html = distPath(html, dist);\r\n      }\r\n      if (js === source) {\r\n        js = distPath(js, dist);\r\n      }\r\n      source = resolvePath(source);\r\n\r\n      html = html || distPath(source, dist);\r\n      js = js || distPath(source, dist).replace('.html', '.js');\r\n\r\n      resolve({\r\n        source: source,\r\n        html: resolvePath(html),\r\n        js: resolvePath(js)\r\n      });\r\n    } catch (error) {\r\n      reject(error);\r\n    }\r\n  });\r\n}\r\n\r\nconst getFileContent = (source, contents) => {\r\n  return new Promise((resolve, reject) => {\r\n    if (contents) {\r\n      return resolve(contents);\r\n    }\r\n    readFile(source, 'utf-8', (error, content) => {\r\n      if (error) {\r\n        reject(error);\r\n      } else {\r\n        resolve(content);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nconst transformParse = string => {\r\n  return new Promise((resolve, reject) => {\r\n    if (!string.includes('<html>')) {\r\n      string = '<!DOCTYPE html><html><head></head><body>' + string + '</body></html>';\r\n    }\r\n    try {\r\n      resolve(parse5.parse(string));\r\n    } catch (error) {\r\n      reject(error)\r\n    }\r\n  })\r\n}\r\n\r\nconst getChildNodes = document => {\r\n  return new Promise(function(resolve, reject) {\r\n    try {\r\n      resolve(document.childNodes[1].childNodes[1].childNodes);\r\n    } catch (error) {\r\n      reject(error)\r\n    }\r\n  });\r\n}\r\n\r\nclass CrisperBase {\r\n  constructor(value, type) {\r\n    this[type] = value;\r\n    this.type = type;\r\n  }\r\n\r\n  get childNodes() {\r\n    if (this.type === 'node') {\r\n      return this.node.childNodes;\r\n    }\r\n    return this[this.type].content.childNodes;\r\n  }\r\n\r\n  get content() {\r\n    let content = '';\r\n    for (let child of this.childNodes) {\r\n      if (isTextNode(child)) {\r\n        content += child.value;\r\n      }\r\n    }\r\n    return content.trim();\r\n  }\r\n\r\n  indexOfAttribute(attribute, node = {}) {\r\n    try {\r\n      const attrs = node.attrs || this[this.type].attrs;\r\n      for (let attr of attrs) {\r\n        if (attr.name.toLowerCase() === attribute.toLowerCase()) {\r\n          return attrs.indexOf(attr);\r\n        }\r\n      }\r\n      return -1;\r\n    } catch (error) {\r\n      console.error(error);\r\n    }\r\n  }\r\n\r\n  hasAttribute(attribute, node) {\r\n    return Boolean(this.indexOfAttribute(attribute, node || this[this.type]) !== -1);\r\n  }\r\n\r\n  getAttribute(attribute) {\r\n    attribute = this[this.type].attrs[this.indexOfAttribute(attribute)].value;\r\n    if (attribute === '') {\r\n      attribute = null;\r\n    }\r\n    return attribute;\r\n  }\r\n\r\n  setAttribute(name, value) {\r\n    if (this.hasAttribute(name))\r\n      this[this.type].attrs[this.indexOfAttribute(name)].value = value;\r\n    else\r\n      this[this.type].attrs.push({\r\n        name: name,\r\n        value: value\r\n      });\r\n  }\r\n\r\n  serializeAttribute(name, value) {\r\n    return `${name}=\"${value}\"`;\r\n  }\r\n\r\n  serializeAttributes() {\r\n    let attributes = '';\r\n    for (let attr of this[this.type].attrs) {\r\n      attributes += ` ${this.serializeAttribute(attr.name, attr.value)}`;\r\n    }\r\n    return attributes;\r\n  }\r\n}\r\n\r\nclass CrisperNode extends CrisperBase {\r\n  constructor(node) {\r\n    super(node, 'node');\r\n  }\r\n}\r\n\r\nclass CrisperTemplate extends CrisperBase {\r\n  constructor(template) {\r\n    super(template, 'template');\r\n  }\r\n\r\n  get id() {\r\n    return this.getAttribute('id');\r\n  }\r\n\r\n  set id(value) {\r\n    this.setAttribute('id', value);\r\n  }\r\n\r\n  get outerHTML() {\r\n    const attributes = this.serializeAttributes();\r\n    return `<template${attributes}>\\n  ${this.content}\\n</template>`\r\n  }\r\n}\r\n\r\n/**\r\n * @module backed-crisper\r\n * by default uses the source as output, so index.html, becomes index.js, index.css & index.html\r\n *\r\n * @param {string} source The file to read\r\n * @param {object} opts\r\n * @param {string} opts.html The ouput path for html\r\n * @param {string} opts.html The ouput path for js\r\n * @param {string} opts.dist A path to set for writing criped files to\r\n */\r\nmodule.exports = (source = null, opts = {html: null, js: null, dist: null, contents: null}) => {\r\n  if (source === null) {\r\n    return console.warn('source::undefined');\r\n  }\r\n\r\n  async function run() {\r\n    const paths = await resolvePaths(source, opts.html, opts.js, opts.dist);\r\n    const content = await getFileContent(paths.source, opts.contents);\r\n    const document = await transformParse(content);\r\n    const childNodes = await getChildNodes(document);\r\n\r\n    let script = null;\r\n    let template = null;\r\n\r\n    for (let child of childNodes) {\r\n      if (!isTextNode(child)) {\r\n        if (child.tagName && child.tagName === 'script') {\r\n          let el = new CrisperNode(child);\r\n          if (!el.hasAttribute('src')) {\r\n            script = el;\r\n          }\r\n        } else if (child.tagName && child.tagName === 'template') {\r\n          template = new CrisperTemplate(child);\r\n        }\r\n      }\r\n    }\r\n\r\n    let scriptTag = null;\r\n    if (script) {\r\n      const relative = relativePath(paths.js);\r\n      scriptTag = `<script src=\"${relative}\"></script>`;\r\n      writeJs(paths.js, script.content);\r\n    }\r\n    if (template) {\r\n      if (template.id === null)\r\n        template.id = path.win32.basename(paths.source, '.html');\r\n        const outerHTML = template.outerHTML;\r\n        let content = scriptTag ? `${scriptTag}\\n\\n${outerHTML}` : outerHTML;\r\n        write(paths.html, content)\r\n      }\r\n    }\r\n\r\n  run();\r\n};\r\n"],"names":["path","require","readFile","mkdir","writeFile","parse5","isTextNode","node","Boolean","nodeName","resolvePath","win32","resolve","process","cwd","source","relativePath","relative","distPath","dest","join","dirname","basename","write","destination","content","error","code","parts","split","sep","prepath","part","console","log","writeJs","resolvePaths","html","js","dist","Promise","reject","duplicates","replace","getFileContent","contents","transformParse","string","includes","parse","getChildNodes","document","childNodes","CrisperBase","value","type","attribute","attrs","attr","name","toLowerCase","indexOf","indexOfAttribute","hasAttribute","push","attributes","serializeAttribute","child","trim","CrisperNode","CrisperTemplate","template","getAttribute","setAttribute","serializeAttributes","module","exports","opts","warn","run","paths","script","tagName","el","scriptTag","id","outerHTML"],"mappings":"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"}